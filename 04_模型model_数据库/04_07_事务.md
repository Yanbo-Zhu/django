
Django默认每条数据库操作都会被立即提交到数据库。
会导致一个问题，若有一系列的数据库操作构成，要么全部执行，要么全部都不执行。
这时需要事务，将一系列数据库操作设置为一个事务，提交给数据库执行。


# 1 操作 

> Django提供atomic装饰器以开启事务，atomic使用一个参数来指定数据库的名字，若不设置，django会使用系统默认的数据库。


2.1：整个View函数开启事务：

```python
from django.db import transaction  
  
@transaction.atomic  
def view(request):  
	"""整个view都开启了事务"""  
    func()  
```

2.2：部分函数开启事务：

```python
from django.db import transaction  
  
def view(request):  
    func()  
	  
	# 下面开始执行事务操作,若出现异常操作，会回退到这里  
    with transaction.atomic():  
	# 开启了事务  
        atmice_func()  
```

2.3：不要再事务中处理异常：

```python
from django.db import transaction  
  
def view(request):  
    func()  
    try:  
        with transaction.commit_on_success():  
            do_more_stuff_1() # in transaction  
            try:  
                do_more_stuff_2() # not in transaction  
            except:  
                pass  
            do_more_stuff_3() # in transaction  
    except:  
        pass  
```

当退出原子块时，Django 会查看它是否正常退出或者是否有异常来确定是否提交或者回滚。

如果你捕获并处理原子块中的异常，可能会隐藏Django中发生问题的事实。


# 2 django命令

| 功能   | mysql命令 | django命令                            |
| ---- | ------- | ----------------------------------- |
| 开启事务 | begin   | sid = transaction.savapoint()       |
| 提交事务 | commit  | transaction.savepoint_commit(sid)   |
| 回滚事务 | rollbok | tramsaction_savepoint_rollback(sid) |