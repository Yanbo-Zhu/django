
Jinja是Python里面被广泛应用的模板引擎，最新版本3.1.3 它的设计思想来源于Django的模板引擎，并扩展了其语法和一系列强大的功能。其中最显著的是增加了沙箱执行功能和可选的自动转义功能，这对大多数应用的安全性来说是非常重要。此外，它还具备以下特性:
- 沙箱执行模式，模板的每个部分都在引擎的监督之下执行，模板将会被明确地标记在白名单或黑名单内，这样对于那些不信任的模板也可以执行。
- 强大的自动HTML转义系统，可以有效地阻止跨站脚本攻击。
- 模板继承机制，此机制可以使得所有模板具有相似一致的布局，也方便开发人员对模板进行修改和管理。
- 高效的执行效率，Jinja3引擎在模板第一次加载时就把源码转换成Python字节码，加快模板执行时间。调试系统融合了标准的Python的TrackBack功能，使得模板编译和运行期间的错误能及时被发现和调试
- 语法配置，可以重新配置Jinja3，使得它更好地适应LaTeX或JavaScript 的输出。官方文档手册，此手册指导设计人员更好地使用Jinja3引擎的各种方法。

Django支持 Jinja3模板引擎的使用，由于Jinja3的设计思想来源于Django 的模板引擎，因此Jinja3的使
用方法与 Django 的模板语法有相似之处。
开源主页： https://github.com/pallets/jinja
官方文档： https://jinja.palletsprojects.com/en/3.1.x/

# 1 Jinja3安装与配置

我们用pip命令安装Jinja3
`pip install Jinja2 -i https://pypi.tuna.tsinghua.edu.cn/simple`

Jinja3安装成功后，接着在 Django里配置Jinja3模板。由于 Django的内置功能是使用 Django的模板引擎，如果将整个项目都改为Jinja3模板引擎，就会导致内置功能无法正常使用。在这种情况下，既要保证内置功能能够正常使用,又要使用Jinja3模板引擎，只能将两个模板引擎共存在同一个项目里。

首先我们在helloWorld项目库里新建Jinja3.py，用来定义环境参数；
```
from django.contrib.staticfiles.storage import staticfiles_storage
from django.urls import reverse
from jinja2 import Environment

def environment(**options):
	env = Environment(**options)
	env.globals.update(
		{
			'static': staticfiles_storage.url,
			'url': reverse
		}
	)
	return env
```

然后我们找到项目配置settings.py

```
def environment(**options):
	env = Environment(**options)
	env.globals.update(
		{
			'static': staticfiles_storage.url,
			'url': reverse
		}
	)
	return env
```

然后我们找到项目配置settings.py
```
"TEMPLATES ="[
   {
      "BACKEND":"django.template.backends.jinja2.Jinja2",
      "DIRS":[
         "BASE_DIR /""templates"
      ],
      "APP_DIRS":true,
      "OPTIONS":{
         "environment":"helloWorld.Jinja3.environment"
      }
   },
   {
      "BACKEND":"django.template.backends.django.DjangoTemplates",
      "DIRS":[
         "BASE_DIR /""helloWorld/templates",
         "BASE_DIR /""templates"
      ],
      "APP_DIRS":true,
      "OPTIONS":{
         "context_processors":[
            "django.template.context_processors.debug",
            "django.template.context_processors.request",
            "django.contrib.auth.context_processors.auth",
            "django.contrib.messages.context_processors.messages"
         ]
      }
   }
]
```


我们找到项目目录下templates的index.html，修改下Jinja3支持的模板语法：

```html
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Title</title>
</head>
<body>
{{ msg2['cat'] }}
</body>
</html>

```


![[03_模版_template/images/Pasted image 20240619194928.png]]


# 2 Jinja3模板语法


尽管Jinja3的设计思想来源于Django 的模板引擎，但在功能和使用细节上，Jinja3比Django的模板引擎更为完善，而且Jinja3的模板语法在使用上与 Django的模板引擎存在一定的差异。
由于Jinja3有模板设计人员帮助手册（官方文档: https://jinja.palletsprojects.com/en/3.1.x/ )，并且官方文档对模板语法的使用说明较为详细，因此这里只讲述Jinja3与 Django模板语言的使用差异。

我们把helloworld子项目下templates下的index.html复制到父项目下的templates下，然后进行修改：

```html
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Title</title>
    </head>
    <body>
        字符串：{{ msg }}<br />
        字典类型：{{ msg2.tom }},{{ msg2.cat }},{{ msg2.wzw }}<br />
        对象：{{ msg3.name }},{{ msg3.age }}<br />
        列表：{{ msg4.0 }},{{ msg4.1 }},{{ msg4.3 }},{{ msg4.2 }}<br />
        元组：{{ msg5.0 }},{{ msg5.4 }},{{ msg5.1 }},{{ msg5.2 }},{{ msg5.3 }}
        <h3>模板标签</h3>
        <p>遍历for标签：</p>
        {% for item in msg4 %}
        <p>这个是第{{ loop.length }}次循环</p>
        {% if loop.first %}
        <p>这个是第一项：{{ item }}</p>
        {% elif loop.last %}
        <p>这个是最后一项：{{ item }}</p>
        {% endif %} {% endfor %}
        <p>判断if标签：</p>
        {% if msg == '模板变量' %}
        <p>模板变量</p>
        {% elif msg == '模板变量2' %}
        <p>模板变量2</p>
        {% else %}
        <p>其他</p>
        {% endif %}
        <p>url标签</p>
        {#<a href="{% url 'index' %}">请求index</a>#}
        <a href="{{ url('index') }}">请求index</a>
        <p>with标签</p>
        {% with info=msg %} {{ info }} {% endwith %}
    </body>
</html>

```


运行测试：
![[03_模版_template/images/Pasted image 20240619200609.png]]

在遍历对象，列表，元组的时候，假如元素或者属性不存在，Jinja3会返回具体的报错信息：no such element
以及url函数用法不一样；在遍历for标签上，属性页不一样，内置的对象是loop

for函数模板变量：
Variable Description
loop.index 循环的当前迭代（索引从1开始)
loop.index0 循环的当前迭代（索引从0开始）
loop.revindex 循环结束时的迭代次数(索引从1开始)
loop.revindex0 循环结束时的迭代次数(索引从0开始)
loop.first 如果是第一次迭代，就为True
loop.last 如果是最后一次迭代，就为True
loop.length 序列中的项目数，即循环总次
loop.cycle 辅助函数,用于在序列列表之间循环
loop.depth 当前递归循环的深度，从1级开始
loop.depth0 当前递归循环的深度，从0级开始
loop.previtem 上一次迭代中的对象
loop.nextitem 下一次迭代中的对象
loop.changed(*val) 若上次迭代的值与当前迭代的值不同，则返回True

我们把base.html和course.html也复制一份到父项目templates下；
base.html需要修改下：

```html
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>
            {% block title %} Python222学院 {% endblock %}
        </title>
    </head>
    {# load不支持，要去掉 #} {#{% load static %}#}
    <body>
        <div id="head">
            {# Django语法 #} {# <img src="{% static 'logo.png' %}" />#} {# Jinja3语法 #}
            <img src="{{ static('logo.png') }}" />
        </div>
        <div id="content">
            {% block content %} 欢迎进入Python222学院 {% endblock %}
        </div>
        <div id="footer">
            版权所有 www.python222.com
        </div>
    </body>
</html>

```


![[03_模版_template/images/Pasted image 20240619200821.png]]

相比较Django，Jinja3在static函数用法上也有区别，模版继承用法基本一致。

# 3 Jinja3过滤器

Jinja3的过滤器与 Django内置过滤器的使用方法有相似之处，也是由管道符号“|”连接模板上下文和过滤器，但是两者的过滤器名称是不同的，而且过滤器的参数设置方式也不同。Jinja3常用过滤器如下表格：

过滤器说明
abs 设置数值的绝对值
default 设置默认值
escape 转义字符，转成HTML的语法
first 获取上下文的第一个元素
last 获取上下文的最后一个元素
length 获取上下文的长度
join 功能与Python的join语法一致
safe 将上下文转义处理
int 将上下文转换为int类型
float 将上下文转换为float类型
lower 将字符串转换为小写
upper 将字符串转换为大写
replace 字符串的替换
truncate 字符串的截断
striptags 删除字符串中所有的HTML标签
trim 截取字符串前面和后面的空白字符
string 将上下文转换成字符串
wordcount 计算长字符串的单词个数

具体使用可以参考下Jinja3官方文档(
https://jinja.palletsprojects.com/en/3.1.x/templates/#filters )


下面我们通过实例来体检下Jinja3的用法吧：
修改index.html：

```
<p>Jinja3过滤器</p>
first: {{ msg | first }}<br>
last:{{ msg | last }}<br>
length:{{ msg | length }}<br>
upper:{{ msg | upper }}
```

运行结果 
![[03_模版_template/images/Pasted image 20240619201011.png]]
