
我们在开发一个网站的时候，无可避免的需要设计实现网站的用户系统。此时我们需要实现包括用户注册、用户登录、用户认证、注销、修改密码等功能，这还真是个麻烦的事情呢。

Django作为一个完美主义者的终极框架，当然也会想到用户的这些痛点。它内置了强大的用户认证系统--auth，可以实现上述需求。它默认使用 auth_user 表来存储用户数据。

前面我们已经通过数据迁移生成了用户权限认证系统的物流表；里面包含系统用户表，权限表，用户组，以及用户组权限关联表，用户和组关联表，用户权限关联表。

![[09_内置Auth认证系统/images/Pasted image 20240619230404.png]]

# 1 用户注册实现

我们实现Auth认证系统里的用户注册的话，用的是auth模版models.py里定义的User模型。
![[09_内置Auth认证系统/images/Pasted image 20240619230551.png]]


通过auth内置的User，我们可以直接操作用户相关功能；

首先urls.py里定义下映射：
```python
# 跳转注册页面
path('auth/toRegister', helloWorld.views.to_register),
# 提交注册请求
path('auth/register', helloWorld.views.register),
```
![[09_内置Auth认证系统/images/Pasted image 20240619230752.png]]

templates下新建auth目录，再新建login.html和register.html两个页面；（用户注册后，跳转到
登录页面）

register.html页面源码：
```html
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>注册页面</title>
    </head>
    <body>
        <form action="/auth/register" method="post">
            {% csrf_token %}
            <table>
                <tr>
                    <th>用户注册</th>
                </tr>
                <tr>
                    <td>用户名：</td>
                    <td><input type="text" name="username" value="{{ username }}" /></td>
                </tr>
                <tr>
                    <td>密码：</td>
                    <td>
                        <input
                            type="password"
                            name="password"
                            value="{{ password
}}"
                        />
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="submit" value="提交" />
                    </td>
                    <td>
                        <font color="red">{{ errorInfo }}</font>
                    </td>
                </tr>
            </table>
        </form>
    </body>
</html>

```

login.html页面源码（临时的）：
```html
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Title</title>
    </head>
    <body>
        登录页面
    </body>
</html>

```

views.py实现to_register和register两个方法。新增用户用的是create_user，判断用户是否存在通过filter

```python
def to_register(request):
	"""
	测试，浏览器输入 http://127.0.0.1:8000/auth/toRegister
	输入用户名和密码，点提交；
	auth_user表，就会有用户数据：
	如果用户名重复，则报错提示：
	跳转注册页面
	:param request:
	:return:
	"""
	return render(request, 'auth/register.html')

def register(request):
	"""
	用户注册
	:param request:
	:return:
	"""
	username = request.POST.get('username')
	password = request.POST.get('password')
	# 检验用户名是否存在
	result = User.objects.filter(username=username)
	if result:
	return render(request, 'auth/register.html',context={"errorInfo": "该用户名已存在", "username": username, "password": password})
	User.objects.create_user(username=username, password=password)
	return render(request, "auth/login.html")
```


![[09_内置Auth认证系统/images/Pasted image 20240619231011.png]]

![[09_内置Auth认证系统/images/Pasted image 20240619231019.png]]


# 2 用户登录实现

用户登录功能，后端验证主要通过auth模块提供的authenticate校验方法，以及login登录方法实现。
首先urls.py里加下映射：

```
# 跳转登录页面
path('auth/toLogin', helloWorld.views.to_login),
# 提交登录请求
path('auth/login', helloWorld.views.login),
```

登录页面login.html：
```html
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>登录页面</title>
    </head>
    <body>
        <form action="/auth/login" method="post">
            {% csrf_token %}
            <table>
                <tr>
                    <th>用户登录</th>
                </tr>
                <tr>
                    <td>用户名：</td>
                    <td><input type="text" name="username" value="{{ username }}" /></td>
                </tr>
                <tr>
                    <td>密码：</td>
                    <td>
                        <input
                            type="password"
                            name="password"
                            value="{{ password
}}"
                        />
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="submit" value="提交" />
                    </td>

                    <td>
                        <font color="red">{{ errorInfo }}</font>
                    </td>
                </tr>
            </table>
        </form>
    </body>
</html>

```

网站首页index.html，登录成功后跳转：
```html
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>网站首页</title>
    </head>
    <body>
        网站首页,欢迎: {{ request.user }}
    </body>
</html>

```


views.py里实现to_login和login方法。
通过auth.authenticate校验用户是否已经存在。校验用户成功后，返回的是一个封装好的用户对象；校验错误则返回None
用户对象is_active方法判断用户是否激活。
通过调用auth.login，用户登录成功之后，返回给客户端登录的凭证或者说是令牌、随机字符串，则不需要我们去操作diango_session表，会自动创建session
当执行完auth.authenticate 和auth.login 后，也就是登录成功后，我们就可以通过 request.user 直接获取到当前登录的用户对象数据
- 登录成功的情况下，该方法获得的是登录用户对象
- 登录不成功的情况下，该方法获得的是匿名对象AnonymousUser

```
def to_login(request):
	"""
	跳转登录页面
	:param request:
	:return:
	"""
	return render(request, 'auth/login.html')

def login(request):
	"""
	登录处理
	:param request:
	:return:
	"""
	username = request.POST.get('username')
	password = request.POST.get('password')
	# 通过auth模块来检验加密后的密码 ，校验成功返回用户对象，否则返回None
	resUser: User = auth.authenticate(request, username=username,password=password)
	if resUser and resUser.is_active:
		print(resUser, type(resUser))
		# 用户登录成功之后（返回给客户端登录的凭证或者说是令牌、随机字符串）
		auth.login(request, resUser)
		return render(request, 'auth/index.html')
	else:
		return render(request, 'auth/login.html',
			context={"errorInfo": "用户名或者密码错误", "username": username, "password": password})
```

![[09_内置Auth认证系统/images/Pasted image 20240619231522.png]]

![[09_内置Auth认证系统/images/Pasted image 20240619231531.png]]

# 3 用户修改密码实现 

用户修改密码主要通过request.user对象的set_password实现，当然校验原密码用check_password，设置完后，需要保存，调用save()方法。
我们urls.py里加下映射；
```
# 修改密码 get请求直接跳转页面，post请求执行处理
path('auth/setPwd', helloWorld.views.setPwd),
```

新建setPwd.html
```html
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>修改密码</title>
    </head>
    <body>
        <form action="/auth/setPwd" method="post">
            {% csrf_token %}
            <table>
                <tr>
                    <th>修改密码</th>
                </tr>
                <tr>
                    <td>用户名：</td>
                    <td>
                        <input
                            type="text"
                            name="username"
                            value="{{ request.user
}}"
                            readonly
                        />
                    </td>
                </tr>
                <tr>
                    <td>原密码：</td>
                    <td><input type="password" name="oldPwd" value="{{ oldPwd }}" /></td>
                </tr>
                <tr>
                    <td>新密码：</td>
                    <td><input type="password" name="newPwd" value="{{ newPwd }}" /></td>
                </tr>
                <tr>
                    <td>
                        <input type="submit" value="提交" />
                    </td>
                    <td>
                        <font color="red">{{ errorInfo }}</font>
                    </td>
                </tr>
            </table>
        </form>
    </body>
</html>

```

views.py里实现setPwd函数：
```python
def setPwd(request):
	"""
	修改密码
	:param request:
	:return:
	"""
	if request.method == "POST":
		oldPwd = request.POST.get("oldPwd")
		newPwd = request.POST.get("newPwd")
		# 1,校验用户密码 check_password
		isRight = request.user.check_password(oldPwd)
		if not isRight:
			return render(request, 'auth/setPwd.html', context={"errorInfo": "原密码错误", "oldPwd": oldPwd, "newPwd": newPwd})
			
		# 2,设置新密码 set_password 实现加密
		request.user.set_password(newPwd)
		
		# 3,保存用户信息
		request.user.save()
		return render(request, 'auth/index.html')
		return render(request, "auth/setPwd.html")
```

![[09_内置Auth认证系统/images/Pasted image 20240619231717.png]]

![[09_内置Auth认证系统/images/Pasted image 20240619231734.png]]


# 4 用户注销实现 

用户注销通过auth.logout方法实现。我们来完善上前面的例子。用户登录后进入主页，显示注销功能；

如果用户没登录，则显示登录功能；

views.py里实现Logout方法：
```
def logout(request):
	"""
	注销
	:param request:
	:return:
	"""
	auth.logout(request)
	return render(request, 'auth/index.html')
```

再实现一个跳转主页的方法to_index：
```
def to_index(request):
"""
跳转主页
:param request:
:return:
"""
return render(request, 'auth/index.html')
```

urls.py里加映射：
```
# 跳转主页
path('auth/index', helloWorld.views.to_index),
# 用户注销
path('auth/logout', helloWorld.views.logout),
```

主页index.html修改如下：
```html
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>网站首页</title>
    </head>
    <body>
        网站首页 {% if request.user.is_authenticated %} ,欢迎: {{ request.user }}<br />
        <a href="/auth/logout">注销</a>
        {% else %}
        <a href="/auth/toLogin">登录</a>
        {% endif %}
    </body>
</html>

```

通过is_authenticated()方法可以判断用户是否登录认证；

![[09_内置Auth认证系统/images/Pasted image 20240619232004.png]]

![[09_内置Auth认证系统/images/Pasted image 20240619232012.png]]


